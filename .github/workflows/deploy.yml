name: Build and Deploy to VPS

on:
  push:
    branches: [main]
  workflow_dispatch: # Manual trigger from GitHub UI

env:
  DEPLOY_PATH: /var/www/gnfi-insight
  ARCHIVE_NAME: build-output.tar.zst

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: ü•ü Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: üì¶ Install dependencies
        run: bun install --frozen-lockfile

      - name: üî® Build application
        run: bun run build

      - name: üóúÔ∏è Compress build output (zstd - best compression)
        run: |
          sudo apt-get install -y zstd
          tar --zstd -cf ${{ env.ARCHIVE_NAME }} .output config
          ls -lh ${{ env.ARCHIVE_NAME }}

      - name: üì§ Transfer to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          source: ${{ env.ARCHIVE_NAME }}
          target: ${{ env.DEPLOY_PATH }}

      - name: üöÄ Deploy on VPS
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script_stop: true
          script: |
            # Set PATH for non-interactive shell (SSH doesn't source .bashrc)
            export PATH="$HOME/n/bin:$HOME/.bun/bin:/usr/local/bin:/usr/bin:$PATH"
            
            cd ${{ env.DEPLOY_PATH }}
            
            echo "üì¶ Extracting build to temp directory..."
            tar --zstd -xf ${{ env.ARCHIVE_NAME }}
            mv .output .output-new
            
            echo "üîÑ Atomic swap (zero downtime)..."
            mv .output .output-old 2>/dev/null || true
            mv .output-new .output
            
            echo "üßπ Cleanup..."
            rm -rf .output-old
            rm -f ${{ env.ARCHIVE_NAME }}

            echo "‚ôªÔ∏è Reloading PM2..."
            pm2 reload all --update-env
            
            echo "‚úÖ Deployment complete!"
            pm2 status

      - name: üì¢ Discord Notification
        if: always()
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          status: ${{ job.status }}
          title: "GNFI Insight Deployment"
          description: |
            **Branch:** `${{ github.ref_name }}`
            **Commit:** `${{ github.sha }}`
            **Author:** ${{ github.actor }}
          color: ${{ job.status == 'success' && '0x00ff00' || '0xff0000' }}
          username: "GitHub Actions"
