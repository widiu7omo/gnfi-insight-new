# Upstream for load balancing between Bun instances
upstream gnfi_insight {
    least_conn;  # Send to least busy server
    server 127.0.0.1:3000;
    server 127.0.0.1:3001;
    keepalive 64;  # Keep connections alive for better performance
}

# Rate limiting zone (prevent abuse)
limit_req_zone $binary_remote_addr zone=gnfi_limit:10m rate=10r/s;

# Proxy cache (optional - for static/semi-static pages)
proxy_cache_path /var/cache/nginx/gnfi levels=1:2 keys_zone=gnfi_cache:10m max_size=100m inactive=60m use_temp_path=off;

server {
    listen                  443 ssl http2;
    listen                  [::]:443 ssl http2;
    server_name             insight.goodnewsfromindonesia.id;

    # SSL certificates
    ssl_certificate         /etc/letsencrypt/live/insight.goodnewsfromindonesia.id/fullchain.pem;
    ssl_certificate_key     /etc/letsencrypt/live/insight.goodnewsfromindonesia.id/privkey.pem;

    # SSL optimization
    ssl_session_cache       shared:SSL:10m;
    ssl_session_timeout     1d;
    ssl_session_tickets     off;
    ssl_buffer_size         4k;  # Smaller buffer = faster TTFB

    # security
    include                 nginxconfig.io/security.conf;

    # Security headers
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # logging
    error_log               /var/log/nginx/insight.error.log warn;
    access_log              /var/log/nginx/insight.access.log combined buffer=512k flush=1m;

    # Static pre-compressed files (zero CPU - serve .gz files directly)
    gzip_static on;

    # Dynamic gzip (only for SSR HTML responses that aren't pre-compressed)
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 5;  # Lower level for dynamic content (speed vs size)
    gzip_min_length 1024;  # Don't compress tiny responses
    gzip_types text/html text/plain text/xml application/json;

    # Proxy to Bun server
    location / {
        # Rate limiting (burst allows 20 requests, then 10/s)
        limit_req zone=gnfi_limit burst=20 nodelay;
        
        proxy_pass http://gnfi_insight;
        proxy_http_version 1.1;
        
        # WebSocket support
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        
        # Forward headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Don't buffer responses (better for SSR)
        proxy_buffering off;
        proxy_cache_bypass $http_upgrade;
    }

    # Static assets - aggressive caching
    location ~* ^\/assets\/.*\.(?:jpg|jpeg|gif|png|ico|cur|gz|svg|svgz|mp4|ogg|ogv|webm|webp|avif)$ {
        proxy_pass http://gnfi_insight;
        
        # Cache at nginx level
        proxy_cache gnfi_cache;
        proxy_cache_valid 200 7d;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        
        expires max;
        access_log off;
        add_header Cache-Control "public, immutable";
        add_header X-Cache-Status $upstream_cache_status;  # Debug: HIT/MISS
    }

    location ~* ^\/assets\/.*\.(?:css|js|woff|woff2|ttf|eot|otf)$ {
        proxy_pass http://gnfi_insight;
        
        proxy_cache gnfi_cache;
        proxy_cache_valid 200 30d;
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        
        expires 1y;
        access_log off;
        add_header Cache-Control "public, immutable";
        add_header X-Cache-Status $upstream_cache_status;
    }

    # additional config
    include nginxconfig.io/general.conf;
}

# HTTP redirect
server {
    listen      80;
    listen      [::]:80;
    server_name .insight.goodnewsfromindonesia.id;
    
    include     nginxconfig.io/letsencrypt.conf;

    # Nginx Bad Bot Blocker
    include /etc/nginx/bots.d/ddos.conf;
    include /etc/nginx/bots.d/blockbots.conf;

    # Redirect to HTTPS
    if ($host = insight.goodnewsfromindonesia.id) {
        return 301 https://$host$request_uri;
    }

    location / {
        return 301 https://insight.goodnewsfromindonesia.id$request_uri;
    }
}

